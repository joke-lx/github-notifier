<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHubæŠ€æœ¯æ—¥æŠ¥ - ç®¡ç†é¢æ¿</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
    }

    .header h1 {
      color: #667eea;
      font-size: 28px;
      margin-bottom: 8px;
    }

    .header p {
      color: #666;
      font-size: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
      color: #333;
      font-size: 18px;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f5f5f5;
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: #666;
      font-size: 14px;
    }

    .stat-value {
      color: #333;
      font-weight: 600;
      font-size: 14px;
    }

    .log-container {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      line-height: 1.6;
    }

    .log-line {
      padding: 4px 0;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .log-line .timestamp {
      color: #858585;
    }

    .log-line.error {
      color: #f48771;
    }

    .log-line.success {
      color: #89d185;
    }

    .log-line.warn {
      color: #dcdcaa;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-right: 8px;
      margin-bottom: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .config-item {
      margin-bottom: 16px;
    }

    .config-item label {
      display: block;
      color: #666;
      font-size: 13px;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .config-item input,
    .config-item select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .config-item input:focus,
    .config-item select:focus {
      outline: none;
      border-color: #667eea;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-success {
      background: #d4edda;
      color: #155724;
    }

    .status-warning {
      background: #fff3cd;
      color: #856404;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
    }

    .report-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .report-item {
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .report-item:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .report-date {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }

    .report-count {
      color: #666;
      font-size: 13px;
    }

    .refresh-indicator {
      display: inline-block;
      margin-left: 8px;
      color: #667eea;
      font-size: 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .refresh-indicator.loading::after {
      content: 'â†»';
      animation: spin 1s linear infinite;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
      <h1>ğŸš€ GitHubæŠ€æœ¯æ—¥æŠ¥ - ç®¡ç†é¢æ¿</h1>
      <p>å®æ—¶ç›‘æ§ã€é…ç½®ç®¡ç†ã€æ—¥å¿—æŸ¥çœ‹</p>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div style="text-align: center; margin-bottom: 24px;">
      <button class="btn" onclick="runTest()">â–¶ è¿è¡Œæµ‹è¯•</button>
      <button class="btn btn-secondary" onclick="refreshAll()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
      <button class="btn btn-secondary" onclick="clearCache()">ğŸ—‘ æ¸…ç©ºç¼“å­˜</button>
    </div>

    <!-- çŠ¶æ€å¡ç‰‡ -->
    <div class="grid">
      <!-- ç³»ç»ŸçŠ¶æ€ -->
      <div class="card">
        <h2>âš™ï¸ ç³»ç»ŸçŠ¶æ€</h2>
        <div class="stat-item">
          <span class="stat-label">è¿è¡Œæ—¶é—´</span>
          <span class="stat-value" id="uptime">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">å†…å­˜ä½¿ç”¨</span>
          <span class="stat-value" id="memory">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Nodeç‰ˆæœ¬</span>
          <span class="stat-value" id="nodeVersion">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">å¹³å°</span>
          <span class="stat-value" id="platform">-</span>
        </div>
      </div>

      <!-- é…ç½®çŠ¶æ€ -->
      <div class="card">
        <h2>ğŸ“‹ é…ç½®çŠ¶æ€ <span class="refresh-indicator" id="configStatus"></span></h2>
        <div id="configValidation"></div>
      </div>

      <!-- ç¼“å­˜ç»Ÿè®¡ -->
      <div class="card">
        <h2>ğŸ’¾ ç¼“å­˜ç»Ÿè®¡</h2>
        <div class="stat-item">
          <span class="stat-label">ç¼“å­˜é¡¹</span>
          <span class="stat-value" id="cacheSize">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">å‘½ä¸­ç‡</span>
          <span class="stat-value" id="cacheHitRate">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">å†…å­˜å ç”¨</span>
          <span class="stat-value" id="cacheMemory">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">æ€»è¯·æ±‚æ•°</span>
          <span class="stat-value" id="cacheRequests">-</span>
        </div>
      </div>

      <!-- å†å²æŠ¥å‘Š -->
      <div class="card">
        <h2>ğŸ“Š å†å²æŠ¥å‘Š <span class="refresh-indicator" id="reportStatus"></span></h2>
        <div class="stat-item">
          <span class="stat-label">æ€»æŠ¥å‘Šæ•°</span>
          <span class="stat-value" id="totalReports">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">æœ€æ–°æŠ¥å‘Š</span>
          <span class="stat-value" id="lastReport">-</span>
        </div>
        <div class="report-list" id="reportList"></div>
      </div>
    </div>

    <!-- å®æ—¶æ—¥å¿— -->
    <div class="card">
      <h2>ğŸ“ å®æ—¶æ—¥å¿— <span class="refresh-indicator" id="logStatus"></span></h2>
      <div class="log-container" id="logContainer">
        <div class="log-line">æ­£åœ¨è¿æ¥æ—¥å¿—æœåŠ¡...</div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '';

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      refreshAll();
      // æ¯5ç§’è‡ªåŠ¨åˆ·æ–°
      setInterval(refreshAll, 5000);
    });

    async function refreshAll() {
      await Promise.all([
        getStatus(),
        getStats(),
        getConfig(),
        getReports(),
        getLogs()
      ]);
    }

    async function getStatus() {
      try {
        const res = await fetch(API_BASE + '/api/status');
        const data = await res.json();

        document.getElementById('uptime').textContent = formatUptime(data.uptime);
        document.getElementById('memory').textContent = formatBytes(data.memory.heapUsed);
        document.getElementById('nodeVersion').textContent = data.version;
        document.getElementById('platform').textContent = data.platform;
      } catch (error) {
        console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
      }
    }

    async function getStats() {
      try {
        const res = await fetch(API_BASE + '/api/stats');
        const data = await res.json();

        // ç¼“å­˜ç»Ÿè®¡
        document.getElementById('cacheSize').textContent = `${data.cache.size}/${data.cache.maxSize}`;
        document.getElementById('cacheHitRate').textContent = data.cache.hitRate;
        document.getElementById('cacheMemory').textContent = data.cache.memoryUsage;
        document.getElementById('cacheRequests').textContent = data.cache.hits + data.cache.misses;

        // å†å²ç»Ÿè®¡
        document.getElementById('totalReports').textContent = data.history.totalReports;
        document.getElementById('lastReport').textContent = data.history.lastReport || 'æ— ';
      } catch (error) {
        console.error('è·å–ç»Ÿè®¡å¤±è´¥:', error);
      }
    }

    async function getConfig() {
      try {
        const res = await fetch(API_BASE + '/api/config');
        const data = await res.json();

        const container = document.getElementById('configValidation');
        if (data.validation.valid) {
          container.innerHTML = '<span class="status-badge status-success">âœ“ é…ç½®æœ‰æ•ˆ</span>';
        } else {
          container.innerHTML = `
            <span class="status-badge status-error">âœ— é…ç½®é”™è¯¯</span>
            <div style="margin-top: 12px;">
              ${data.validation.errors.map(e => `<div style="color: #721c24; font-size: 13px; margin: 4px 0;">â€¢ ${e.message}</div>`).join('')}
            </div>
          `;
        }
      } catch (error) {
        console.error('è·å–é…ç½®å¤±è´¥:', error);
      }
    }

    async function getReports() {
      try {
        const res = await fetch(API_BASE + '/api/reports');
        const data = await res.json();

        const list = document.getElementById('reportList');
        if (data.dailyReports && data.dailyReports.length > 0) {
          list.innerHTML = data.dailyReports
            .slice(-10)
            .reverse()
            .map(r => `
              <div class="report-item">
                <div class="report-date">${r.date}</div>
                <div class="report-count">${r.repositories?.length || 0} ä¸ªé¡¹ç›®</div>
              </div>
            `).join('');
        } else {
          list.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">æš‚æ— æŠ¥å‘Š</div>';
        }
      } catch (error) {
        console.error('è·å–æŠ¥å‘Šå¤±è´¥:', error);
      }
    }

    async function getLogs() {
      try {
        const res = await fetch(API_BASE + '/api/logs?limit=50');
        const data = await res.json();

        const container = document.getElementById('logContainer');
        container.innerHTML = data.logs.map(line => {
          const className = line.includes('ERROR') || line.includes('å¤±è´¥') || line.includes('âœ—') ? 'error' :
                           line.includes('âœ“') || line.includes('æˆåŠŸ') ? 'success' :
                           line.includes('âš ') || line.includes('WARN') ? 'warn' : '';
          return `<div class="log-line ${className}">${escapeHtml(line)}</div>`;
        }).join('');

        container.scrollTop = container.scrollHeight;
      } catch (error) {
        console.error('è·å–æ—¥å¿—å¤±è´¥:', error);
      }
    }

    async function runTest() {
      if (!confirm('ç¡®å®šè¦è¿è¡Œæµ‹è¯•ä»»åŠ¡å—ï¼Ÿè¿™å°†æ‰§è¡Œå®Œæ•´çš„æ—¥æŠ¥æµç¨‹ã€‚')) {
        return;
      }

      try {
        await fetch(API_BASE + '/api/test', { method: 'POST' });
        alert('æµ‹è¯•ä»»åŠ¡å·²å¯åŠ¨ï¼Œè¯·æŸ¥çœ‹å®æ—¶æ—¥å¿—');
      } catch (error) {
        alert('å¯åŠ¨æµ‹è¯•å¤±è´¥: ' + error.message);
      }
    }

    async function clearCache() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¼“å­˜å—ï¼Ÿ')) {
        return;
      }

      try {
        await fetch(API_BASE + '/api/cache', { method: 'DELETE' });
        alert('ç¼“å­˜å·²æ¸…ç©º');
        getStats();
      } catch (error) {
        alert('æ¸…ç©ºç¼“å­˜å¤±è´¥: ' + error.message);
      }
    }

    // å·¥å…·å‡½æ•°
    function formatUptime(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
    }

    function formatBytes(bytes) {
      const mb = bytes / 1024 / 1024;
      return mb.toFixed(2) + ' MB';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
